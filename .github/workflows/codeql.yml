name: Python Type Check

on:
  push:
  merge_group:

jobs:
  analyze:
    name: Analyze
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write  # æ·»åŠ åˆ›å»ºissueçš„æƒé™

    strategy:
      fail-fast: false
      matrix:
        language: [ 'python' ]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install project dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install .
          python -m pip install mypy types-requests types-setuptools

      # Type checking with mypy
      - name: Run mypy
        run: |
          mypy --python-version 3.10 --show-column-numbers --show-error-codes --ignore-missing-imports kirara_ai --output json > mypy_output.json
        continue-on-error: true

      # å¤„ç†mypyç»“æžœå¹¶åˆ›å»ºIssue
      - name: Process mypy results and create issue
        if: always()
        run: |
          cat > mypy-issue-creator.py << 'EOF'
          #!/usr/bin/env python3
          import json
          import os
          import datetime
          
          # è¯»å– mypy JSON è¾“å‡º
          try:
              with open("mypy_output.json", "r") as f:
                  content = f.read()
                  if content.strip():
                      mypy_results = [json.loads(line) for line in content.splitlines() if line.strip()]
                  else:
                      print("mypy_output.json æ–‡ä»¶ä¸ºç©º")
                      mypy_results = []
          except FileNotFoundError:
              print("è­¦å‘Šï¼šmypy_output.json æ–‡ä»¶ä¸å­˜åœ¨ã€‚åˆ›å»ºç©ºç»“æžœåˆ—è¡¨ã€‚")
              mypy_results = []
          except json.JSONDecodeError as e:
              print(f"è§£æž JSON æ—¶å‡ºé”™: {e}")
              with open("mypy_output.json", "r") as f:
                  print(f"æ–‡ä»¶å†…å®¹: {f.read()[:1000]}")  # æ‰“å°æ–‡ä»¶å†…å®¹çš„å‰1000ä¸ªå­—ç¬¦ä»¥ä¾¿è°ƒè¯•
              mypy_results = []
          
          # æŒ‰æ–‡ä»¶å’Œé”™è¯¯ç±»åž‹ç»„ç»‡ç»“æžœ
          results_by_file = {}
          
          for result in mypy_results:
              file_path = result.get("file", "æœªçŸ¥æ–‡ä»¶")
              if file_path not in results_by_file:
                  results_by_file[file_path] = []
              results_by_file[file_path].append(result)
          
          # åˆ›å»ºç¾Žè§‚çš„MarkdownæŠ¥å‘Š
          today = datetime.datetime.now().strftime("%Y-%m-%d")
          run_url = f"https://github.com/{os.environ.get('GITHUB_REPOSITORY')}/actions/runs/{os.environ.get('GITHUB_RUN_ID')}"
          
          issue_title = f"Mypy ç±»åž‹æ£€æŸ¥æŠ¥å‘Š ({today})"
          
          # æž„å»ºMarkdownå†…å®¹
          markdown = f"# Mypy ç±»åž‹æ£€æŸ¥æŠ¥å‘Š\n\n"
          markdown += f"**ç”Ÿæˆæ—¶é—´**: {today}\n"
          markdown += f"**å·¥ä½œæµè¿è¡Œ**: [æŸ¥çœ‹è¿è¡Œè¯¦æƒ…]({run_url})\n\n"
          
          # æ·»åŠ æ‘˜è¦ç»Ÿè®¡
          error_count = len(mypy_results)
          file_count = len(results_by_file)
          
          markdown += f"## æ‘˜è¦\n\n"
          markdown += f"- å‘çŽ° **{error_count}** ä¸ªç±»åž‹é—®é¢˜\n"
          markdown += f"- å½±å“ **{file_count}** ä¸ªæ–‡ä»¶\n\n"
          
          # é”™è¯¯ç±»åž‹ç»Ÿè®¡
          error_types = {}
          for result in mypy_results:
              error_code = result.get("code", "unknown")
              if error_code not in error_types:
                  error_types[error_code] = 0
              error_types[error_code] += 1
          
          if error_types:
              markdown += "### é”™è¯¯ç±»åž‹ç»Ÿè®¡\n\n"
              markdown += "| é”™è¯¯ç±»åž‹ | æ•°é‡ |\n"
              markdown += "|---------|------|\n"
              for error_type, count in sorted(error_types.items(), key=lambda x: x[1], reverse=True):
                  markdown += f"| `{error_type}` | {count} |\n"
              markdown += "\n"
          
          # æŒ‰æ–‡ä»¶å±•ç¤ºè¯¦ç»†é—®é¢˜
          if results_by_file:
              markdown += "## è¯¦ç»†é—®é¢˜\n\n"
              
              for file_path, errors in sorted(results_by_file.items()):
                  relative_path = file_path
                  markdown += f"### ðŸ“„ {relative_path}\n\n"
                  
                  # æŒ‰è¡Œå·æŽ’åº
                  errors.sort(key=lambda x: x.get("line", 0))
                  
                  markdown += "| è¡Œ:åˆ— | é”™è¯¯ç±»åž‹ | æ¶ˆæ¯ |\n"
                  markdown += "|-------|----------|------|\n"
                  
                  for error in errors:
                      line = error.get("line", "?")
                      column = error.get("column", "?")
                      position = f"{line}:{column}"
                      error_code = f"`{error.get('code', 'unknown')}`"
                      message = error.get("message", "").replace("|", "\\|")  # è½¬ä¹‰è¡¨æ ¼åˆ†éš”ç¬¦
                      
                      markdown += f"| {position} | {error_code} | {message} |\n"
                  
                  markdown += "\n"
          else:
              markdown += "## ðŸŽ‰ æ²¡æœ‰å‘çŽ°ç±»åž‹é—®é¢˜!\n\n"
          
          # æ·»åŠ å¸®åŠ©ä¿¡æ¯
          markdown += "## å¸®åŠ©\n\n"
          markdown += "- [Mypy é”™è¯¯ä»£ç åˆ—è¡¨æ–‡æ¡£](https://mypy.readthedocs.io/en/stable/error_code_list.html)\n"
          markdown += "- [Python ç±»åž‹æç¤ºæŒ‡å—](https://mypy.readthedocs.io/en/stable/cheat_sheet_py3.html)\n"
          
          # å°†Markdownå†…å®¹å†™å…¥æ–‡ä»¶
          with open("mypy_report.md", "w") as f:
              f.write(markdown)
          
          print(f"æˆåŠŸå¤„ç† {len(mypy_results)} ä¸ª mypy é”™è¯¯å¹¶ç”ŸæˆæŠ¥å‘Š")
          EOF
          
          python mypy-issue-creator.py

      # æŸ¥æ‰¾æ˜¯å¦å·²æœ‰ç›¸åŒæ ‡é¢˜çš„issue
      - name: Find existing issues
        uses: actions/github-script@v6
        id: find-issue
        with:
          script: |
            const title = `Mypy ç±»åž‹æ£€æŸ¥æŠ¥å‘Š (${new Date().toISOString().slice(0, 10)})`;
            const issues = await github.paginate(github.rest.issues.listForRepo, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'type-check'
            });
            
            // æŸ¥æ‰¾ç›¸ä¼¼æ ‡é¢˜çš„issue
            const existingIssue = issues.find(i => i.title.startsWith('Mypy ç±»åž‹æ£€æŸ¥æŠ¥å‘Š'));
            if (existingIssue) {
              console.log(`Found existing issue: #${existingIssue.number}`);
              return existingIssue.number;
            }
            return null;

      # æ›´æ–°æˆ–åˆ›å»ºissue
      - name: Update or create issue
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const issueBody = fs.readFileSync('mypy_report.md', 'utf8');
            const title = `Mypy ç±»åž‹æ£€æŸ¥æŠ¥å‘Š (${new Date().toISOString().slice(0, 10)})`;
            const labels = ['type-check', 'automated-report'];
            
            const existingIssueNumber = ${{ steps.find-issue.outputs.result }};
            
            if (existingIssueNumber) {
              // æ›´æ–°çŽ°æœ‰issue
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssueNumber,
                title: title,
                body: issueBody
              });
              console.log(`Updated issue #${existingIssueNumber}`);
            } else {
              // åˆ›å»ºæ–°issue
              const { data } = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: issueBody,
                labels: labels
              });
              console.log(`Created issue #${data.number}`);
            }
